{% extends 'base.html.twig' %}

{% block title %}My Profile
{% endblock %}

{% block body %}
	<div class="min-h-screen bg-white text-black font-sans py-12">
		<div class="max-w-6xl mx-auto px-4 md:px-6">

			<div class="mb-12 border-b border-gray-200 pb-6 flex justify-between items-end">
				<div>
					<h1 class="text-4xl font-black tracking-tighter mb-2">My Account</h1>
					<p class="text-gray-500">Manage your info and view your impact.</p>
				</div>
				<div class="hidden md:block text-sm font-mono text-gray-400">
					Member since
					{{ user.createdAt|date('M Y') }}
				</div>
			</div>

			<div class="grid grid-cols-1 lg:grid-cols-3 gap-12">

				<div class="lg:col-span-1">
					<div class="bg-white border-2 border-black rounded-xl p-8 shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] sticky top-8">

						<div class="flex flex-col items-center text-center mb-6">
							<div class="relative mb-4 group">
								<img class="w-24 h-24 rounded-full border-2 border-black object-cover" src="{{ user.profilePicture ? asset('uploads/' ~ user.profilePicture) : 'https://ui-avatars.com/api/?name=' ~ user.name|url_encode ~ '&background=000&color=fff&size=128' }}" alt="{{ user.name }}">
								<div class="absolute bottom-0 right-0 bg-white border-2 border-black rounded-full p-1 cursor-pointer hover:bg-gray-100">
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
									</svg>
								</div>
							</div>

							<h2 class="text-2xl font-black">{{ user.name }}</h2>
							<p class="text-gray-500 font-medium mb-1">{{ user.email }}</p>
							<span class="inline-block px-3 py-1 bg-gray-100 text-xs font-bold uppercase tracking-wider rounded-full mt-2">
								{{ user.role == 'ROLE_ADMIN' ? 'Administrator' : 'Backer' }}
							</span>
						</div>

						<div class="grid grid-cols-2 gap-4 border-t border-b border-gray-100 py-6 mb-6">
							<div class="text-center">
								<span class="block text-2xl font-black">{{ donations|length }}</span>
								<span class="text-xs text-gray-400 uppercase font-bold">Projects Backed</span>
							</div>
							<div class="text-center border-l border-gray-100">
								{% set total = 0 %}
								{% for d in donations %}
									{% set total = total + d.amount %}
								{% endfor %}
								<span class="block text-2xl font-black">${{ total|number_format }}</span>
								<span class="text-xs text-gray-400 uppercase font-bold">Total Given</span>
							</div>
						</div>

						<button onclick="toggleEditModal(true)" class="w-full bg-black text-white font-bold py-3 rounded-lg hover:bg-gray-800 transition-all active:translate-y-1 active:shadow-none flex justify-center items-center gap-2">
							<svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
							</svg>
							Edit Profile
						</button>
						<button onclick="togglePasswordModal(true)" class="w-full mt-3 bg-white text-black font-bold py-3 rounded-lg border-2 border-black hover:bg-gray-100 transition-all active:translate-y-1 active:shadow-none flex justify-center items-center gap-2">
							<svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
							</svg>
							Change Password
						</button>
					</div>
				</div>

				<div class="lg:col-span-2">
					<h3 class="text-xl font-black mb-6 flex items-center gap-2">
						<svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
						</svg>
						Donation History
					</h3>

					<div class="space-y-4">
						{% for donation in donations %}
							<div class="group bg-white border-2 border-gray-100 rounded-xl p-5 hover:border-black transition-colors duration-300 flex flex-col md:flex-row md:items-center justify-between gap-4">

								<div class="flex items-center gap-4">
									<div class="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden border border-gray-200 flex-shrink-0">
										{% if donation.project.image %}
											<img src="{{ donation.project.image }}" class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all">
										{% else %}
											<div class="w-full h-full flex items-center justify-center text-gray-300 font-bold text-xs">IMG</div>
										{% endif %}
									</div>

									<div>
										<h4 class="font-bold text-lg leading-tight">
											<a href="{{ path('app_project_show', {id: donation.project.id}) }}" class="hover:underline">
												{{ donation.project.title }}
											</a>
										</h4>
										<p class="text-sm text-gray-500 mt-1">
											{{ donation.createdAt|date('F j, Y') }}
											at
											{{ donation.createdAt|date('H:i') }}
										</p>
									</div>
								</div>

								<div class="flex items-center justify-between md:justify-end gap-6 w-full md:w-auto border-t md:border-none pt-4 md:pt-0 border-gray-50">
									<div class="text-right">
										<span class="block font-mono font-black text-xl">${{ donation.amount }}</span>
										<span class="text-xs uppercase font-bold text-gray-400">Amount</span>
									</div>

									<div class="px-3 py-1 rounded border-2 text-xs font-bold uppercase
																						                                        {{ donation.paymentStatus == 'paid' ? 'bg-black text-white border-black' : 'bg-white text-gray-400 border-gray-200' }}">
										{{ donation.paymentStatus }}
									</div>
								</div>

							</div>
						{% else %}
							<div class="text-center py-16 border-2 border-dashed border-gray-200 rounded-xl bg-gray-50">
								<p class="text-gray-400 font-medium mb-4">You haven't supported any projects yet.</p>
								<a href="{{ path('app_project_index') }}" class="inline-block bg-black text-white font-bold px-6 py-2 rounded-lg hover:bg-gray-800 transition">
									Explore Projects
								</a>
							</div>
						{% endfor %}
					</div>
				</div>

			</div>
		</div>

		<div id="editProfileModal" class="fixed inset-0 z-50 hidden">
			<div class="absolute inset-0 bg-white/90 backdrop-blur-sm" onclick="toggleEditModal(false)"></div>

			<div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-4 animate-in fade-in zoom-in-95 duration-200">
				<div class="bg-white border-2 border-black rounded-xl p-8 shadow-[12px_12px_0px_0px_rgba(0,0,0,1)] relative">

					<button onclick="toggleEditModal(false)" class="absolute top-4 right-4 text-gray-400 hover:text-black transition-colors">
						<svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
					</button>

					<h3 class="text-2xl font-black mb-8 text-center">Update Profile</h3>

					{{ form_start(form, {'attr': {'id': 'profile-form'}}) }}

					<div class="flex flex-col items-center mb-8">
						<div class="relative group cursor-pointer" onclick="document.getElementById('profile_profilePicture').click()">
							<img id="imagePreview" src="{{ app.user.profilePicture ? asset('uploads/' ~ app.user.profilePicture) : 'https://ui-avatars.com/api/?name=' ~ app.user.name|url_encode ~ '&background=000&color=fff' }}" class="w-24 h-24 rounded-full object-cover border-2 border-black shadow-sm group-hover:opacity-50 transition-opacity" alt="Profile Preview">

							<div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200">
								<svg class="w-8 h-8 text-black" fill="none" stroke="currentColor" viewbox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
								</svg>
							</div>
						</div>
						<p class="text-xs text-gray-400 mt-2 font-bold uppercase tracking-wider">Tap to change photo</p>

						<div class="hidden">
							{{ form_widget(form.profilePicture, {'attr': {'onchange': 'previewImage(this)'}}) }}
						</div>
						<div class="text-red-500 text-xs mt-1">{{ form_errors(form.profilePicture) }}</div>
					</div>

					<div class="space-y-5">
						<div class="group">
							<label class="block text-xs font-black uppercase tracking-widest text-gray-500 mb-2 group-focus-within:text-black transition-colors">Full Name</label>
							{{ form_widget(form.name, {'attr': {
                            'class': 'w-full bg-gray-50 border-2 border-gray-200 rounded-lg p-3 text-black font-bold outline-none focus:bg-white focus:border-black transition-all duration-200 placeholder:text-gray-300',
                            'placeholder': 'Enter your name'
                        }}) }}
							<div class="text-red-500 text-xs mt-1 font-bold">{{ form_errors(form.name) }}</div>
						</div>

						<div class="group">
							<label class="block text-xs font-black uppercase tracking-widest text-gray-500 mb-2 group-focus-within:text-black transition-colors">Email Address</label>
							{{ form_widget(form.email, {'attr': {
                            'class': 'w-full bg-gray-50 border-2 border-gray-200 rounded-lg p-3 text-black font-bold outline-none focus:bg-white focus:border-black transition-all duration-200 placeholder:text-gray-300',
                            'placeholder': 'name@example.com'
                        }}) }}
							<div class="text-red-500 text-xs mt-1 font-bold">{{ form_errors(form.email) }}</div>
						</div>
					</div>

					<div class="mt-10 flex gap-4">
						<button type="button" onclick="toggleEditModal(false)" class="px-6 py-3 border-2 border-gray-200 text-gray-500 font-bold rounded-lg hover:border-black hover:text-black transition-colors">
							Cancel
						</button>
						<button type="submit" class="flex-1 bg-black text-white font-bold py-3 rounded-lg hover:bg-gray-800 transition-all active:translate-y-1 active:shadow-none shadow-lg">
							Save Changes
						</button>
					</div>

					{{ form_end(form) }}
				</div>
			</div>
		</div>

		<!-- Password Change Modal -->
		<div id="passwordModal" class="fixed inset-0 z-50 hidden">
			<div class="absolute inset-0 bg-white/90 backdrop-blur-sm" onclick="togglePasswordModal(false)"></div>

			<div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-4 animate-in fade-in zoom-in-95 duration-200">
				<div class="bg-white border-2 border-black rounded-xl p-8 shadow-[12px_12px_0px_0px_rgba(0,0,0,1)] relative">

					<button onclick="togglePasswordModal(false)" class="absolute top-4 right-4 text-gray-400 hover:text-black transition-colors">
						<svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
					</button>

					<div class="flex justify-center mb-6">
						<div class="bg-gray-100 p-4 rounded-full">
							<svg class="w-8 h-8" fill="none" stroke="currentColor" viewbox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
							</svg>
						</div>
					</div>

					<h3 class="text-2xl font-black mb-2 text-center">Change Password</h3>
					<p class="text-gray-500 text-sm text-center mb-8">Enter your current password and choose a new one</p>

					{{ form_start(passwordForm, {'attr': {'id': 'password-form'}}) }}

					<div class="space-y-5">
						<div class="group">
							<label class="block text-xs font-black uppercase tracking-widest text-gray-500 mb-2 group-focus-within:text-black transition-colors">Current Password</label>
							{{ form_widget(passwordForm.currentPassword, {'attr': {
								'class': 'w-full bg-gray-50 border-2 border-gray-200 rounded-lg p-3 text-black font-bold outline-none focus:bg-white focus:border-black transition-all duration-200 placeholder:text-gray-300',
								'placeholder': '••••••••'
							}}) }}
							<div class="text-red-500 text-xs mt-1 font-bold">{{ form_errors(passwordForm.currentPassword) }}</div>
						</div>

						<div class="group">
							<label class="block text-xs font-black uppercase tracking-widest text-gray-500 mb-2 group-focus-within:text-black transition-colors">New Password</label>
							{{ form_widget(passwordForm.newPassword.first, {'attr': {
								'class': 'w-full bg-gray-50 border-2 border-gray-200 rounded-lg p-3 text-black font-bold outline-none focus:bg-white focus:border-black transition-all duration-200 placeholder:text-gray-300',
								'placeholder': '••••••••'
							}}) }}
							<div class="text-red-500 text-xs mt-1 font-bold">{{ form_errors(passwordForm.newPassword.first) }}</div>
						</div>

						<div class="group">
							<label class="block text-xs font-black uppercase tracking-widest text-gray-500 mb-2 group-focus-within:text-black transition-colors">Confirm New Password</label>
							{{ form_widget(passwordForm.newPassword.second, {'attr': {
								'class': 'w-full bg-gray-50 border-2 border-gray-200 rounded-lg p-3 text-black font-bold outline-none focus:bg-white focus:border-black transition-all duration-200 placeholder:text-gray-300',
								'placeholder': '••••••••'
							}}) }}
							<div class="text-red-500 text-xs mt-1 font-bold">{{ form_errors(passwordForm.newPassword.second) }}</div>
						</div>
					</div>

					<div class="mt-10 flex gap-4">
						<button type="button" onclick="togglePasswordModal(false)" class="px-6 py-3 border-2 border-gray-200 text-gray-500 font-bold rounded-lg hover:border-black hover:text-black transition-colors">
							Cancel
						</button>
						<button type="submit" class="flex-1 bg-black text-white font-bold py-3 rounded-lg hover:bg-gray-800 transition-all active:translate-y-1 active:shadow-none shadow-lg">
							Update Password
						</button>
					</div>

					{{ form_end(passwordForm) }}
				</div>
			</div>
		</div>

	</div>

	<script>
		function toggleEditModal(show) {
            const modal = document.getElementById('editProfileModal');
            if (show) {
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            } else {
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            }
            }
            function togglePasswordModal(show) {
            const modal = document.getElementById('passwordModal');
            if (show) {
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            } else {
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            }
            }
            function previewImage(input) {
            if (input.files && input.files[0]) {
            var reader = new FileReader();

            reader.onload = function (e) {
            document.getElementById('imagePreview').src = e.target.result;
            }

            reader.readAsDataURL(input.files[0]);
            }
            }
	</script>
{% endblock %}
